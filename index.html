<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>指尖上的廉洁地图</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script type="text/javascript">
        var CDN_URL = "https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/";
        function isMobileBrowser() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        /*if(isMobileBrowser()){
            if(window.orientation == 90 || window.orientation == -90){
                document.body.classList.remove('landscape')
                map.enableDragging();
            }else{
                document.body.classList.add('landscape')
                map.disableDragging();
            }
        }else{
            document.body.classList.remove('landscape')
            map.enableDragging();
        }*/
    </script>
    <!--<script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
<script>
  var vConsole = new window.VConsole();
</script>-->
    <script src="https://api.map.baidu.com/api?type=webgl&v=1.0&ak=ymNFeWvGjzIRnGeXjXb91AGUseb2IROT" type="text/javascript"></script>
    <script type="text/javascript" src="js/AreaRestriction.js"></script>

    <script src="//code.bdstatic.com/npm/mapvgl@1.0.0-beta.141/dist/mapvgl.min.js" type="text/javascript"></script>
    <style>
        body,
        html,
        #container {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "微软雅黑";
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1e1e1e;
            }
        }

        .landscape {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            transform-origin: center center;
            width: calc(var(--vh, 1svh) * 100);
            height: 100vw;
        }

        .blur {
            filter: blur(5px);
        }

        /* 横屏样式 */
        @media screen and (orientation: landscape) {

            .logo-container{
                position: absolute;
                z-index: 99999;
                top: calc(var(--vh, 1svh) * 3);
                left: calc(var(--vh, 1svh) * 3);
                width: calc(var(--vh, 1svh) * 14);
                height: calc(var(--vh, 1svh) * 14);
                overflow:hidden;
            }
            .music-container{
                position: absolute;
                z-index: 99999;
                /*top: calc(var(--vh, 1svh) * 3);
                right: calc(var(--vh, 1svh) * 3);
                width: calc(var(--vh, 1svh) * 8);
                height: calc(var(--vh, 1svh) * 8);*/
                top: calc(var(--vh, 1svh) * 3);
                right: calc(var(--vh, 1svh) * 1);
                width: 56px;
                height: 56px;
            }
            .loading-bg {
                width: 100vw;
                height: calc(var(--vh, 1svh) * 100);
                object-fit: cover;
                object-position: center;
            }
            .ydy-bg {
                width: 100vw;
                height: calc(var(--vh, 1svh) * 100);
                object-fit: cover;
                object-position: center;
            }

            /* 在这里定义横屏时的样式 */
            .loading-container {
                width: 100vw;
                height: calc(var(--vh, 1svh) * 100);
                background-size: cover;
                background-position: center;
            }
            
            .enter-btn{
                width: 30vw;
                height: calc(var(--vh, 1svh) * 6);
                /*border-radius: 50vw;
                border: 0.125em solid;*/
                color: #083054;
                position: absolute;
                bottom: calc(var(--vh, 1svh) * 30);
                left: calc((100vw - 30vw) / 2);
                font-size: 20px;
                font-weight: bold;
                text-align: center;
                line-height: 36px;
                justify-content: center;
                display: flex;
                align-items: center;
            }

            .ydy-container {
                background: url('https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/ydy.png');
                width: 100vw;
                height: calc(var(--vh, 1svh) * 100);
                background-size: cover;
                background-position: center;
                position: absolute;
                z-index: 999;
                background-color: rgba(0, 0, 0, 0.5);
                overflow:hidden;
            }

            .zdy-container {
                background: url('https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/zdy.png');
                width: 100vw;
                height: calc(var(--vh, 1svh) * 100);
                background-size: cover;
                background-position: center;
                position: absolute;
                z-index: 998;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .loader-progress-bar {
                width: 30vw;
                height: calc(var(--vh, 1svh) * 6);
                border-radius: 50vw;
                border: 0.125em solid;
                color: #083054;
                position: absolute;
                bottom: calc(var(--vh, 1svh) * 30);
                left: calc((100vw - 30vw) / 2);
                font-size: 20px;
            }
            .ydy-map-btn{
                left: calc(var(--vh, 1svh) * 15);
                position: absolute;
                bottom: calc(var(--vh, 1svh) * 3);
                cursor: pointer;
                width: calc(var(--vh, 1svh) * 55);
            }
            .ydy-line-btn{
                right: calc(var(--vh, 1svh) * 15);
                position: absolute;
                bottom: calc(var(--vh, 1svh) * 3);
                cursor: pointer;
                width: calc(var(--vh, 1svh) * 55);
            }
        }

        @media screen and (orientation: portrait) {
            .anchorBR{
                transform: translateZ(1000px);
            }
            .logo-container{
                position: absolute;
                z-index: 99999;
                top: 3vw;
                left: 3vw;
                width: 14vw;
                height: 14vw;
                transform: translateZ(1000px);
            }
            .music-container{
                position: absolute;
                z-index: 99999;
                /*top: 3vw;
                right: 3vw;
                width: 8vw;
                height: 8vw;*/
                top: 3vw;
                right: 2.5vw;
                width: 46px;
                height: 46px;
                transform: translateZ(1000px);
            }
            .loading-bg {
                width: calc(var(--vh, 1svh) * 100);
                height: 100vw;
                object-fit: cover;
                object-position: center;
            }
            .ydy-bg {
                position: absolute;
                left: calc(var(--vh, 1svh) * 1);
                width: calc(var(--vh, 1svh) * 98);
                height: calc(var(--vh, 1svh) * 98 / 16 * 9);
                object-fit: cover;
                object-position: center;
                max-height: 98vw;
                top: calc((100vw - var(--vh, 1svh)* 98 / 16* 9) / 2);
            }

            .loading-container {
                width: calc(var(--vh, 1svh) * 100);
                height: 100vw;
                background-size: cover;
                background-position: center;
            }
            .enter-btn{
                width: 70vw;
                height: calc(var(--vh, 1svh) * 3);
                /*border-radius: 50vw;
                border: 0.125em solid;*/
                color: #083054;
                position: absolute;
                bottom: 28vw;
                left: calc((var(--vh, 1svh) * 100 - 70vw) / 2);
                font-size: 18px;
                font-weight: bold;
                text-align: center;
                line-height: 18px;
                justify-content: center;
                display: flex;
                align-items: center;
            }

            .ydy-container {
                width: calc(var(--vh, 1svh) * 100);
                height: 100vw;
                background-size: cover;
                background-position: center;
                position: absolute;
                z-index: 999;
                background-color: rgba(0, 0, 0, 0.5);
                transform: translateZ(1000px);
            }

            .zdy-container {
                background: url('https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/zdy.png');
                width: calc(var(--vh, 1svh) * 100);
                height: 100vw;
                background-size: cover;
                background-position: center;
                position: absolute;
                z-index: 998;
                background-color: rgba(0, 0, 0, 0.5);
                transform: translateZ(1000px);
            }

            .loader-progress-bar {
                width: 70vw;
                height: calc(var(--vh, 1svh) * 3);
                border-radius: 50vw;
                border: 0.125em solid;
                color: #083054;
                position: absolute;
                bottom: 28vw;
                left: calc((var(--vh, 1svh) * 100 - 70vw) / 2);
                font-size: 18px;
            }
            .ydy-map-btn{
                left: calc(var(--vh, 1svh) * 15);
                position: absolute;
                top: 77vw;
                cursor: pointer;
                width: calc(var(--vh, 1svh) * 31);
            }
            .ydy-line-btn{
                right: calc(var(--vh, 1svh) * 15);
                position: absolute;
                top: 77vw;
                cursor: pointer;
                width: calc(var(--vh, 1svh) * 31);
            }
        }


        #toggle:checked~#sect .loader-progress-bar {
            filter: drop-shadow(0.2em 0.2em 0.2em rgba(0, 0, 0, 0.5));
        }

        .loader-progress-bar:before,
        .loader-progress-bar:after {
            content: "";
            top: 0.2em;
            left: 0.2em;
            right: 0.2em;
            bottom: 0.2em;
            border-radius: 50vw;
            display: block;
            position: absolute;
            overflow: hidden;
        }

        .loader-progress-bar:after {
            right: 100%;
            -webkit-animation: loaderBarInfinite 3s infinite linear, loaderBarScroll 3s infinite linear;
            animation: loaderBarInfinite 3s infinite linear, loaderBarScroll 3s infinite linear;
            box-shadow: inset 0 0.5em 0.5em rgba(105, 191, 240, 0.25), inset 0 -0.5em 0.5em rgba(75, 132, 164, 1);
            background-color: rgb(105, 191, 240);
            background-size: 26px 13px;
        }

        @-webkit-keyframes loaderBarInfinite {
            from {
                background-position: 104px 0;
            }

            to {
                background-position: -104px 0;
            }
        }

        @keyframes loaderBarInfinite {
            from {
                background-position: 104px 0;
            }

            to {
                background-position: -104px 0;
            }
        }

        @-webkit-keyframes loaderBarScroll {
            to {
                right: 2%;
            }
        }

        @keyframes loaderBarScroll {
            to {
                right: 2%;
            }
        }
    </style>
</head>

<body class="landscape">
    
    <script type="text/javascript">
        // 获取视口高度
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            //document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // 初始化视口高度
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        if(isMobileBrowser()){
            if(window.orientation == 90 || window.orientation == -90){
                document.body.classList.remove('landscape')
                map.enableDragging();
            }else{
                document.body.classList.add('landscape')
                map.disableDragging();
            }
        }else{
            document.body.classList.remove('landscape')
            map.enableDragging();
        }
    </script>
    <div class="logo-container" id="logo-container">
        <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/logolvse.png" style="width: 100%;height: 100%;">
    </div>
    <div class="music-container" id="music-container">
        <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/music-close.png" id="music-btn" style="width: 100%;height: 100%;" onclick="musiccontrol(this);">
    </div>
    <audio id="backgroundMusic" src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/mp3/bgm1.mp3" loop autoplay></audio>
    <div class="loading-container" id="loading-container">
        <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/loading-bg1.jpg" class="loading-bg">
        <div class="loader-progress-bar" id="loader-progress-bar"></div>
        <div class="enter-btn" id="enter-btn" style="display: none;" onclick="musiccontrol();document.getElementById('loading-container').style.display = 'none';document.getElementById('logo-container').style.display = 'none';">点此进入</div>
    </div>
    <div style="position: absolute;z-index: 0;display: none;" id="loadingImgCache"></div>
    <div class="ydy-container" id="ydy-container">
        <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/ydy.png" class="ydy-bg">
        <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/ydy-map.png" class="ydy-map-btn" 
            onclick="document.getElementById('ydy-container').style.display='none';document.getElementById('zdy-container').style.visibility='visible';"
            onload="imgloaded();">
        <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/ydy-line.png" class="ydy-line-btn" 
            onclick="document.getElementById('ydy-container').style.display='none';document.getElementById('zdy-container').style.visibility='visible';use_lineselect=true;"
            onload="imgloaded();">
    </div>
    <div class="zdy-container" id="zdy-container" style="visibility: hidden;"
        onclick="document.getElementById('zdy-container').style.display='none';document.getElementById('logo-container').style.display = 'block';noblurmap();start();if(use_lineselect){document.getElementById('lineControl').click();}">
    </div>

    <div id="container" class="blur" style="visibility: hidden;"></div>
    <!--<canvas id="overlayCanvas" style="position:absolute; top:0; left:0; width:100%;height:100%;z-index: 999;"></canvas>-->
    <style>
        /* 竖屏样式 */
        @media screen and (orientation: portrait) {

            /* 在这里定义竖屏时的样式 */
            .modal-content {
                background-size: cover;
                width: calc(var(--vh, 1svh) * 100);
                height: 100vw;
                position: relative;
                background-position: center;
                /*left: calc((var(--vh, 1svh) * 100 - 170.78vw) / 2);*/
                max-width: calc(var(--vh, 1svh) * 100);
                max-height: calc(var(--vh, 1svh) * 56.25);
                transform: translateZ(1000px);
            }

            .mc-header {
                position: absolute;
                top: 28vw;
                left: calc((177vw - 100vw) / 2);
                width: 100vw;
                height: 18vw;
            }

            .mc-content-bg {
                position: absolute;
                top: 46vw;
                left: calc((177vw - 100vw) / 2);
                width: 100vw;
                height: 28vw;
                background: white;
                border: 2px solid #ffe985;
                border-radius: 20px;
            }

            .mc-content {
                position: absolute;
                top: 2vw;
                left: 5vw;
                width: 90vw;
                height: 24vw;
            }

            .lineSelect-container {
                position: absolute;
                width: calc(var(--vh, 1svh) * 41);
                height: 102vw;
                background-color: rgba(0, 0, 0, 0.75);
                top: -1vw;
                display: flex;
                align-content: center;
                flex-direction: column;
                justify-content: center;
                z-index: 999;
                transform: translateZ(1000px);
            }
            .zhedie{
                left: calc(var(--vh, 1svh) * -37);
            }
            .zhankai{
                left: calc(var(--vh, 1svh) * -1);
            }
            .arrow-btn{    
                position: absolute;
                right: 0;
                color: white;
                width: calc(var(--vh, 1svh) * 4);
                text-align: center;
                padding: 10vw 0;
                font-size: 24px;
                line-height: 48px;
                font-weight: bold;
            }

            .button {
                position: absolute;
                top: 82vw;
                cursor: pointer;
                width: calc(var(--vh, 1svh) * 31);
            }

            .lineDesc-container {
                position: absolute;
                width: calc(var(--vh, 1svh) * 45);
                /*height: 20vw;*/
                z-index: 999;
                background-color: rgba(255,255,255,0.75);
                bottom: 7vw;
                left: calc(var(--vh, 1svh) * 41);
                padding: 15px;
                border-radius: 15px;
                border: 2px solid #99cceb;
                font-size: 14px;
                display: flex;
                /*justify-content: center;
                align-items: center;*/
                transform: translateZ(1000px);
            }
            .close {
                position: absolute;
                top: calc((115vw - var(--vh, 1svh)* 98 / 16* 9) / 2);
                /*right: calc((var(--vh, 1svh) * 100 - 177.78vw) / 2 + var(--vh, 1svh) * 6);*/
                right: calc(var(--vh, 1svh) * 5);
                cursor: pointer;
                width: 5%;
            }
            .itemModalImg{
                position: absolute;
                width: calc(var(--vh, 1svh) * 98);
                height: calc(var(--vh, 1svh) * 98 / 16 * 9);
                left: calc(var(--vh, 1svh) * 1);
                object-fit: cover;
                object-position: center;
                max-height: 98vw;
                top: calc((100vw - var(--vh, 1svh)* 98 / 16* 9) / 2);
            }
        }

        /* 横屏样式 */
        @media screen and (orientation: landscape) {

            /* 在这里定义横屏时的样式 */
            .modal-content {
                background-size: cover;
                width: calc(var(--vh, 1svh) * 177);
                height: calc(var(--vh, 1svh) * 100);
                position: relative;
                left: calc((100vw - var(--vh, 1svh) * 177) / 2);
                background-position: center;
            }

            .lineSelect-container {
                position: absolute;
                width: 40vw;
                height: calc(var(--vh, 1svh) * 100);
                background-color: rgba(0, 0, 0, 0.75);
                top: 0;
                display: flex;
                align-content: center;
                flex-direction: column;
                justify-content: center;
                z-index: 999;
            }
            .zhedie{
                left: -36vw;
            }
            .zhankai{
                left: 0;
            }
            .arrow-btn{    
                position: absolute;
                right: 0;
                color: white;
                width: 4vw;
                text-align: center;
                padding: 10vw 0;
                font-size: 24px;
                line-height: 48px;
                font-weight: bold;
            }

            .button {
                position: absolute;
                bottom: calc(var(--vh, 1svh) * 3);
                cursor: pointer;
                width: calc(var(--vh, 1svh) * 55);
            }

            .lineDesc-container {
                position: absolute;
                width: 48vw;
                /*height: calc(var(--vh, 1svh) * 20);*/
                z-index: 999;
                background-color: rgba(255,255,255,0.75);
                bottom: calc(var(--vh, 1svh) * 7);
                left: 40.5vw;
                padding:18px 8px;
                border-radius: 15px;
                border: 2px solid #99cceb;
                font-size: 14px;
                display: flex;
                /*justify-content: center;
                align-items: center;*/
            }
            .close {
                position: absolute;
                top: calc(var(--vh, 1svh) * 11.5);
                right: calc(var(--vh, 1svh) * 6);
                cursor: pointer;
                width: 5%;
            }
            .itemModalImg{
                width: calc(var(--vh, 1svh) * 177.78);
                height: calc(var(--vh, 1svh) * 100);
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .lineitem {
            text-align: left;
            color: #aaa;
            font-size: 14px;
            line-height: 28px;
            padding: 0 calc(var(--vh, 1svh) * 3);
        }
        .lineheader {
            text-align: left;
            color: #aaa;
            font-size: 18px;
            line-height: 36px;
            padding: 0 calc(var(--vh, 1svh) * 5);
        }
        .dhyy-btn{
            left: calc(var(--vh, 1svh) * 15);
        }
        .yjdh-btn{
            right: calc(var(--vh, 1svh) * 15);
        }
    </style>
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <img src="" id="itemModalImg" class="itemModalImg">
            <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/close.png" alt="Close" class="close"
                onclick="document.getElementById('itemModal').style.display = 'none';document.getElementById('music-container').style.display = 'block';noblurmap();noblurdiv('lineDesc-container');noblurdiv('lineSelect-container');document.getElementById('logo-container').style.display = 'block';">
            <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/dhyy.png" alt="Button 1" class="button dhyy-btn"
                onclick="callPhoneNumber(document.getElementById('itemModal').dataset.phone);">
            <img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/yjdh.png" alt="Button 2" class="button yjdh-btn" onclick="yjdh()">
            <script type="text/javascript">
                function yjdh() {
                    var name = document.getElementById('itemModal').dataset.iM_name;
                    var lat = document.getElementById('itemModal').dataset.lat;
                    var lng = document.getElementById('itemModal').dataset.lng;
                    var rlat = document.getElementById('itemModal').dataset.rlat;
                    var rlng = document.getElementById('itemModal').dataset.rlng;
                    var address = document.getElementById('itemModal').dataset.address;
                    var url = "http://api.map.baidu.com/marker?location=" + rlat+","+rlng + "&title=" + name + "&content=" + address + "&output=html&src=webapp.baidu.openAPIdemo";
                    window.open(url, "_blank");
                    //window.location.href = "https://map.baidu.com/search/" + name + "/?querytype=s&da_src=shareurl&wd=" + name + "&c=303&src=0&pn=0&sug=1&l=12"
                }
                function callPhoneNumber(phoneNumber) {
                    window.open('tel:' + phoneNumber);
                }
            </script>
        </div>
    </div>
    <div id="lineSelect-container" class="lineSelect-container zhankai" style="display: none;">
        <div class="arrow-btn" id="arrow-btn" onclick="zhankaizhedie()"><img src="https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/close.png" style="width: 70%;"/></div>
    </div>
    <div id="lineDesc-container" class="lineDesc-container" style="display: none;"></div>
    <script type="text/javascript">
        var use_lineselect = false;
        var map;
        var mapview,lineLayer;
        fetch('js/custom_map_config.json').then(response => response.json())
            .then(data => {
                map = new BMapGL.Map("container", {
                    minZoom: 11,
                    maxZoom: 13,
                    fixCenterWhenPinch: false,
                    style: {
                        styleJson: data,
                    },
                });
                fetch('geo.json')
                    .then(response => response.json())
                    .then(data => {
                        geoData = data;
                        data.forEach(infospot => {
                            infospot.lnglat = new BMapGL.Point(infospot.lng, infospot.lat);
                            addMarker(infospot);
                        });
                        fetch('line.json')
                            .then(response => response.json())
                            .then(data => {
                                lineData = data;
                                fetchRegionDetails(lineData, geoData);
                            })
                            .catch(error => console.error('Error:', error));
                    })
                    .catch(error => console.error('Error:', error));
                map.centerAndZoom(new BMapGL.Point(116.707825, 23.359542), 11);
                //map.disablePinchToZoom();
                map.enableScrollWheelZoom();
                map.addEventListener('dragging', function () {
                    map.setHeading(0);
                    map.setTilt(0);
                });
                map.addEventListener('moving', function () {
                    map.setHeading(0);
                    map.setTilt(0);
                });
                map.addEventListener('zoomstart', function () {
                    map.setHeading(0);
                    map.setTilt(0);
                });
                map.addEventListener('zoomend', function () {
                    map.setHeading(0);
                    map.setTilt(0);
                });
                // 添加自定义控件到地图
                map.addControl(new ZoomInControl());
                map.addControl(new ZoomOutControl());
                //map.addControl(new musicControl());
                map.addControl(new lineControl());
                updateimgOverlay(CDN_URL+'images/map.jpg');
                checkOrientation();
                document.getElementsByClassName('anchorBL')[0].style.visibility = 'hidden';
                document.getElementsByClassName('anchorBL')[0].style.opacity = '0';
                try {
                    BMapGLLib.AreaRestriction.setBounds(map, viewbounds);
                } catch (e) {
                    console.log(e);
                }
                mapview = new mapvgl.View({
                    map: map
                });
                lineLayer = new mapvgl.LineRainbowLayer({
                    dashArray:[20, 10],
                    style: 'road', // road, arrow, normal
                    width: 5,
                    lineCap: 'round',
                    lineJoin: 'round',
                    color: ["#ff3636EE"],
                    animation:true,
                    interval:0.5,
                    trailLength:0.9
                });
                mapview.addLayer(lineLayer);
            })
            .catch(error => console.error('Error:', error));
        var imgcount = 0;
        var imgOverlay;
        var imgOverlayCache = {};

        function updateimgOverlay(url) {
            if (imgOverlay == null) {
                imgOverlay = new BMapGL.GroundOverlay(viewbounds, {
                    type: 'image',
                    url: url,
                    opacity: 1
                });
                map.addOverlay(imgOverlay);
            } else {
                if (imgOverlayCache.hasOwnProperty(getfilename(url))) {
                    var e = imgOverlayCache[getfilename(url)];
                    //imgOverlay.setImageObject(e);
                    imgOverlay._config.src = url;
                    imgOverlay._texture = e;
                    imgOverlay.doOnceDraw();
                    imgOverlay.draw();
                    return true;
                } else {
                    imageLoad(url, function (e, isSuccess) {
                        if (!isSuccess) {
                            updateimgOverlay(url);
                            return false;
                        }
                        imgOverlayCache[getfilename(url)] = e;
                        //imgOverlay.setImageObject(e);
                        imgOverlay._config.src = url;
                        imgOverlay._texture = e;
                        imgOverlay.doOnceDraw();
                        imgOverlay.draw();
                        return true;
                    });
                }
            }
        }

        function imageLoad(url, callback) {
            var e = new Image();
            e.url = url;
            e.crossOrigin = "anonymous";
            e.onload = function () {
                callback && callback(this, true)
            };
            e.onerror = function () {
                callback && callback(null, false)
            };
            e.src = url
        }

        function imgloaded() {
            imgcount++;
            if (imgcount >= 35) {
                document.getElementById('container').style.visibility = 'visible';
                document.getElementById('loader-progress-bar').style.display = 'none';
                document.getElementById('enter-btn').style.display = 'flex';
            }
        }
        function getfilename(url){
            if (url.includes('/')) {
                var lastPart = url.split('/').pop();
            }else{
                var lastPart = url;
            }
            return lastPart
        }
        function preload(){
            imageLoad(CDN_URL+'images/map.jpg', function (e, isSuccess) {
                imgOverlayCache[getfilename(e.url)] = e;
                imgloaded();
                return true;
            });
            for(var i = 1;i<9;i++){
                imageLoad(CDN_URL+'images/line' + i + '.jpg', function (e, isSuccess) {
                    imgOverlayCache[getfilename(e.url)] = e;
                    imgloaded();
                    return true;
                });
            }
            for (var i = 1; i < 25; i++) {
                createAndInsertImg(CDN_URL+"images/" + i + ".png");
            }
        }

        var startX, startY, centerPoint, Gzoom;
        Gzoom = false;

        // 定义所需的经纬度范围
        var pStart = new BMapGL.Point(116.08, 23.66);
        var pEnd = new BMapGL.Point(117.28, 23.034);
        var viewbounds = new BMapGL.Bounds(new BMapGL.Point(pStart.lng, pEnd.lat), new BMapGL.Point(pEnd.lng, pStart
            .lat));

        function blurmap() {
            document.getElementById("container").classList.add('blur')
        }

        function noblurmap() {
            document.getElementById("container").classList.remove('blur')
        }

        function blurdiv(id) {
            document.getElementById(id).classList.add('blur')
        }

        function noblurdiv(id) {
            document.getElementById(id).classList.remove('blur')
        }

        function zhankaizhedie(){
            if(document.getElementById("lineSelect-container").classList.contains('zhankai')){
                document.getElementById("lineSelect-container").classList.add('zhedie');
                document.getElementById("lineSelect-container").classList.remove('zhankai');
                document.getElementById("arrow-btn").style.transform = "rotate(180deg)";
            }else{
                document.getElementById("lineSelect-container").classList.add('zhankai');
                document.getElementById("lineSelect-container").classList.remove('zhedie');
                document.getElementById("arrow-btn").style.transform = "rotate(0deg)";
            }
        }

        function checkOrientation() {
            if(isMobileBrowser()){
                if(window.orientation == 90 || window.orientation == -90){
                    document.body.classList.remove('landscape')
                    map.enableDragging();
                }else{
                    document.body.classList.add('landscape')
                    map.disableDragging();
                }
            }else{
                document.body.classList.remove('landscape')
                map.enableDragging();
            }
            var mapCanvas = document.getElementById('platform');
            var haslimit = false;
            mapCanvas.addEventListener('touchstart', function (e) {
                const firstTouch = event.touches[0];
                startX = firstTouch.clientX;
                startY = firstTouch.clientY;
                if (event.touches.length == 2) {
                    Gzoom = true;
                    centerPoint = map.getCenter();
                }
            });
            mapCanvas.addEventListener('touchmove', function (e) {
                if (event.touches.length == 1 && !Gzoom) {
                    const firstTouch = event.touches[0];
                    let currentX = firstTouch.clientX;
                    let currentY = firstTouch.clientY;
                    let diffX = currentX - startX;
                    let diffY = currentY - startY;
                    var bounds = map.getBounds();
                    var center = map.getCenter();
                    map.panBy(diffY, -diffX, {
                        noAnimation: true
                    });
                    BMapGLLib.AreaRestriction._mapMoveendEvent(e);
                    startX = currentX;
                    startY = currentY;
                }
                map.setHeading(0);
                map.setTilt(0);
            });
            mapCanvas.addEventListener('touchend', function (e) {
                startX = 0;
                startY = 0;
                if (Gzoom) {
                    setTimeout(function () {
                        map.panTo(centerPoint, {
                            noAnimation: true
                        });
                    }, 50);
                    Gzoom = false;
                }
                map.setHeading(0);
                map.setTilt(0);
            });
        }

        function createAndInsertImg(src) {
            // 创建img元素
            const img = document.createElement('img');
            img.onload = imgloaded;
            img.src = src;

            // 获取要插入图片的div元素
            const div = document.getElementById('loadingImgCache');

            // 将img元素插入到div中
            div.appendChild(img);
        }

        window.addEventListener("DOMContentLoaded", function () {
            preload();
        });
        // 在页面加载和屏幕旋转时检测屏幕方向
        //window.addEventListener("load", checkOrientation);
        window.addEventListener("orientationchange", checkOrientation);

        // 添加区域掩膜
        /*addMapMask('chq.json');
        addMapMask('hjq.json');
        addMapMask('jpq.json');
        addMapMask('lhq.json');
        addMapMask('cyq.json');
        addMapMask('cnq.json');
        addMapMask('nax.json');*/

        var geoData = null;
        var lineData = null;


        var plcolor = ['#C3FFA5', '#B5EF60', '#197BAA', '#499330', '#A1ADE0', '#D7AF90', '#326CA8', '#6E9581'];

        function fetchRegionDetails(toursData, geoData) {
            toursData.forEach(tour => {
                var linepoint = [];
                const matchedRegions = tour.regions.map(regionId => {
                    const region = geoData.find(item => item.id == regionId);
                    linepoint.push([region.lng, region.lat]);
                    return region ? region : `ID为${regionId}的地区信息未找到`;
                });
                //console.log(`线路名称: ${tour.name}, 区域详情:`, matchedRegions);
                //var polyline = new BMapGL.Polyline(linepoint, {strokeColor:plcolor[tour.lineid-1], strokeWeight:10, strokeOpacity:0.75,linkRight:true,strokeLineCap:'square'});
                //map.addOverlay(polyline);

                var newDiv = document.createElement('div');
                newDiv.textContent = tour.name;
                newDiv.classList.add('lineitem');
                newDiv.onclick = function () {
                    var elements = document.getElementsByClassName('lineitem');
                    for (var i = 0; i < elements.length; i++) {
                        if (this == elements[i]) {
                            elements[i].style.color = '#ffffff';
                            updateimgOverlay(CDN_URL+'images/line' + (i + 1) + '.jpg');
                            var data = [{
                                geometry: {
                                    type: 'LineString',
                                    coordinates: linepoint
                                }
                            }];
                            lineLayer.setData(data);
                        } else {
                            elements[i].style.color = '#aaa';
                        }
                    }
                    map.flyTo(matchedRegions[0].lnglat, 11);
                    var str = "";
                    for (var i in matchedRegions) {
                        str += "【" + matchedRegions[i].name + "】 - ";
                    }
                    str = str.slice(0,-2);
                    document.getElementById('lineDesc-container').innerText = str;
                    document.getElementById('lineDesc-container').style.display = 'flex';
                }
                var containerDiv = document.getElementById('lineSelect-container');
                containerDiv.appendChild(newDiv);
            });
        }

        var iconsize = 100;

        function CustomSymbol(_size, _anchor) {
            BMapGL.Symbol.call(this, _size, _anchor);
            this.width = _size.width;
            this.height = _size.height;
            this.isReDraw = true;
        }
        CustomSymbol.prototype = new BMapGL.Symbol();
        CustomSymbol.prototype.constructor = CustomSymbol;
        CustomSymbol.prototype.add = function () {
            const canvas = document.createElement('canvas');
            canvas.width = this.width * 2;
            canvas.height = this.height * 2;
            this.context = canvas.getContext('2d');
            this.isReDraw = false;

        }
        CustomSymbol.prototype.render = function (map) {
            const duration = 1000;
            const t = (performance.now() % duration) / duration;

            // 可以通过修改 0.3 0.7
            var outerRadius = (this.width / 2) * (0.1 * t + 0.1);
            if (t > 0.5) {
                outerRadius = (this.width / 2) * (0.1 * (1 - t) + 0.1);
            }
            const context = this.context;
            context.save();
            // 2倍图
            context.scale(2, 2);
            context.clearRect(0, 0, this.width, this.height);

            // 扩散圆
            context.beginPath();
            context.arc(
                this.width / 2,
                this.height / 2,
                outerRadius,
                0,
                Math.PI * 2
            );
            context.strokeStyle = 'rgba(255,255,255,1)'
            context.lineWidth = 2;
            context.stroke();

            context.restore();

            // 更新图像的像素数据
            this.data = context.getImageData(
                0,
                0,
                this.context.canvas.width,
                this.context.canvas.height
            );
            return true;
        }
        var custom = new CustomSymbol(new BMapGL.Size(iconsize, iconsize), new BMapGL.Size(iconsize / 2, iconsize /
            2));

        function start() {
            custom.isReDraw = true;

        }
        //停止动画
        function stop() {
            custom.isReDraw = false;
        }

        function addMarker(infospot) {
            var marker = new BMapGL.Marker(infospot.lnglat, {
                icon: custom
            });
            map.addOverlay(marker);
            //markerstart();
            // 开启拖拽功能
            //marker.enableDragging();

            // 监听标记拖动结束事件
            /*marker.addEventListener('dragend', function(e) {
                var newPosition = e.point;
                var lnglat=map.mercatorToLnglat(newPosition.lng , newPosition.lat);

                // 复制移动后的坐标
                var copyText = document.createElement('input');
                copyText.value = '"lng": "'+lnglat[0] + '",\r\n"lat": "' + lnglat[1]+'",';
                document.body.appendChild(copyText);
                copyText.select();
                document.execCommand('copy');
                document.body.removeChild(copyText);

                alert('已复制新位置坐标！'+ lnglat[0] + ', ' + lnglat[1]);
            });*/
            marker.addEventListener("click", function () {
                blurmap();
                blurdiv('lineDesc-container');
                blurdiv('lineSelect-container');
                document.getElementById('logo-container').style.display = 'none';
                document.getElementById('music-container').style.display = 'none';
                document.getElementById('itemModal').style.display = 'block';
                document.getElementById('itemModalImg').src = CDN_URL+'images/' + infospot.id + '.png';
                document.getElementById('itemModal').dataset.lat = infospot.lat;
                document.getElementById('itemModal').dataset.lng = infospot.lng;
                document.getElementById('itemModal').dataset.rlat = infospot.rlat;
                document.getElementById('itemModal').dataset.rlng = infospot.rlng;
                document.getElementById('itemModal').dataset.address = infospot.address;
                document.getElementById('itemModal').dataset.phone = infospot.phone;
                document.getElementById('itemModal').dataset.iM_name = infospot.name;
            });
            /*var label = new BMapGL.Label(infospot.name, {
                position: infospot.lnglat,
                offset: new BMapGL.Size(-30, -20)
            })  
            map.addOverlay(label); */
        }

        function addMapMask(name) {
            fetch(name)
                .then(response => response.json())
                .then(rs => {
                    for (var i = 0; i < rs.length; i++) {
                        var path = [];
                        var xyArr = rs[i].split(';');
                        var ptArr = [];
                        for (var j = 0; j < xyArr.length; j++) {
                            var tmp = xyArr[j].split(',');
                            var pt = new BMapGL.Point(tmp[0], tmp[1]);
                            ptArr.push(pt);
                        }
                        var mapmask = new BMapGL.MapMask(ptArr, {
                            isBuildingMask: true,
                            isPoiMask: true,
                            isMapMask: true,
                            showRegion: 'inside',
                            topFillColor: '#5679ea',
                            topFillOpacity: 0.5,
                            sideFillColor: '#5679ea',
                            sideFillOpacity: 0.9
                        });
                        map.addOverlay(mapmask);
                        var border = new BMapGL.Polyline(ptArr, {
                            strokeColor: '#4ca7a2',
                            strokeWeight: 3,
                            strokeOpacity: 1
                        });
                        //map.addOverlay(border);
                    }
                })
                .catch(error => console.error('Error:', error));
            /*var bdary = new BMapGL.Boundary();
            bdary.get(name, function (rs) {
                // 绘制行政区
                console.log(name);
                console.log(JSON.stringify(rs.boundaries));
                for (var i = 0; i < rs.boundaries.length; i++) {
                    var path = [];
                    var xyArr = rs.boundaries[i].split(';');
                    var ptArr = [];
                    for (var j = 0; j < xyArr.length; j++) {
                        var tmp = xyArr[j].split(',');
                        var pt = new BMapGL.Point(tmp[0], tmp[1]);
                        ptArr.push(pt);
                    }
                    var mapmask = new BMapGL.MapMask(ptArr, {
                        isBuildingMask: true,
                        isPoiMask: true,
                        isMapMask: true,
                        showRegion: 'inside',
                        topFillColor: '#5679ea',
                        topFillOpacity: 0.5,
                        sideFillColor: '#5679ea',
                        sideFillOpacity: 0.9
                    });
                    map.addOverlay(mapmask);
                    var border = new BMapGL.Polyline(ptArr, {
                        strokeColor: '#4ca7a2',
                        strokeWeight: 3,
                        strokeOpacity: 1
                    });
                    map.addOverlay(border);
                }
            });*/
        }

        // 自定义放大控件
        function ZoomInControl() {
            this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
            this.defaultOffset = new BMapGL.Size(10, 100);
        }

        ZoomInControl.prototype = new BMapGL.Control();

        ZoomInControl.prototype.initialize = function (map) {
            var div = document.createElement("div");
            div.style.width = "42px";
            div.style.height = "42px";
            div.style.backgroundImage = 'url("https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/zoom-in.png")'; // 放大图标
            div.style.backgroundSize = 'cover';
            div.style.cursor = "pointer";
            div.onclick = function () {
                map.zoomIn();
            };
            map.getContainer().appendChild(div);
            return div;
        };

        // 自定义缩小控件
        function ZoomOutControl() {
            this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
            this.defaultOffset = new BMapGL.Size(10, 40);
        }

        ZoomOutControl.prototype = new BMapGL.Control();

        ZoomOutControl.prototype.initialize = function (map) {
            var div = document.createElement("div");
            div.style.width = "42px";
            div.style.height = "42px";
            div.style.backgroundImage = 'url("https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/zoom-out.png")'; // 缩小图标
            div.style.backgroundSize = 'cover';
            div.style.cursor = "pointer";
            div.onclick = function () {
                map.zoomOut();
            };
            map.getContainer().appendChild(div);
            return div;
        };


        // 自定义音乐控件
        /*function musicControl() {
            this.defaultAnchor = BMAP_ANCHOR_TOP_RIGHT;
            this.defaultOffset = new BMapGL.Size(10, 10);
        }

        musicControl.prototype = new BMapGL.Control();

        musicControl.prototype.initialize = function (map) {
            var div = document.createElement("div");
            div.style.width = "48px";
            div.style.height = "48px";
            div.style.backgroundImage = 'url("images/music-open.png")';
            div.style.backgroundSize = 'cover';
            div.style.cursor = "pointer";
            div.onclick = function () {
                if (div.style.backgroundImage == 'url("images/music-open.png")') {
                    div.style.backgroundImage = 'url("images/music-close.png")';
                    document.getElementById('backgroundMusic').pause();
                } else {
                    div.style.backgroundImage = 'url("images/music-open.png")';
                    document.getElementById('backgroundMusic').play();
                }
            };
            map.getContainer().appendChild(div);
            return div;
        };*/
        function musiccontrol() {
            if (document.getElementById("music-btn").src.includes('images/music-open.png')) {
                document.getElementById("music-btn").src = 'https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/music-close.png';
                document.getElementById('backgroundMusic').pause();
            } else {
                document.getElementById("music-btn").src = 'https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/music-open.png';
                document.getElementById('backgroundMusic').play();
            }
        };

        // 自定义线路控件
        function lineControl() {
            this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
            this.defaultOffset = new BMapGL.Size(10, 180);
        }

        lineControl.prototype = new BMapGL.Control();

        lineControl.prototype.initialize = function (map) {
            var div = document.createElement("div");
            div.style.width = "46px";
            div.style.height = "46px";
            div.style.backgroundImage = 'url("https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/line-btn.png")';
            div.style.backgroundSize = 'cover';
            div.style.cursor = "pointer";
            div.id = "lineControl";
            div.onclick = function () {
                if (div.style.backgroundImage.includes('images/line-btn.png')) {
                    div.style.backgroundImage = 'url("https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/map-btn.png")';
                } else {
                    div.style.backgroundImage = 'url("https://maph5-1258456742.cos.ap-guangzhou.myqcloud.com/images/line-btn.png")';
                    imgOverlay.setImage(CDN_URL+'images/map.jpg');
                }
                if (document.getElementById('lineSelect-container').style.display == 'flex') {
                    var elements = document.getElementsByClassName('lineitem');
                    for (var i = 0; i < elements.length; i++) {
                        elements[i].style.color = '#aaa';
                    }
                    lineLayer.setData([]);
                    document.getElementById('lineSelect-container').style.display = 'none';
                    document.getElementById('lineDesc-container').style.display = 'none';

                } else {
                    document.getElementById('lineSelect-container').style.display = 'flex';
                    document.getElementById("lineSelect-container").classList.add('zhankai');
                    document.getElementById("lineSelect-container").classList.remove('zhedie');
                    document.getElementById("arrow-btn").style.transform = "rotate(0deg)";
                }
            };
            map.getContainer().appendChild(div);
            return div;
        };
    </script>
</body>

</html>